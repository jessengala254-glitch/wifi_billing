<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Leo Konnect ‚Äî Affordable Internet for Everyone</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="expires" content="-1" />
<link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
<header class="navbar">
  <div class="container nav-flex">
      <a href="#" class="logo">
        <span class="icon-wifi"></span> Leo <span>Konnect</span>
      </a>
    <nav>
      <a href="plans.php">Plans</a>
      <a href="about.php">About</a>
      <a href="contact.php">Contact</a>
    </nav>
    <div class="nav-btns">
      <a href="login.php" class="signin">Sign In</a>
      <a href="register.php" class="btn-primary">Get Started</a>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container hero-content">
    <h1>Affordable Internet<br>For Everyone</h1>
    <p>Pay-as-you-go WiFi starting from just <span>Ksh 10</span> per hour.<br>
       Stay connected without breaking the bank.</p>
    <div class="hero-buttons">
      <a href="#plans" class="btn-primary">View Plans</a>
      <a href="#login" class="btn-outline">Get Connected</a>
    </div>
    <div class="hero-features">
      <span>‚ö° High-Speed Mbps</span>
      <span>üöÄ Instant Activation</span>
      <span>üîí No Contracts</span>
    </div>
  </div>
  <div class="wave"></div>
</section>

<!-- Login Section -->
<section id="login" class="login-section">
  <!-- MikroTik CHAP Authentication -->
  $(if chap-id)
      <form name="sendin" action="$(link-login-only)" method="post" style="display:none;">
          <input type="hidden" name="username" />
          <input type="hidden" name="password" />
          <input type="hidden" name="dst" value="$(link-orig)" />
          <input type="hidden" name="popup" value="true" />
      </form>
      
      <script type="text/javascript" src="/md5.js"></script>
      <script type="text/javascript">
      function doLogin() {
          document.sendin.username.value = document.login.username.value;
          document.sendin.password.value = hexMD5('$(chap-id)' + document.login.password.value + '$(chap-challenge)');
          document.sendin.submit();
          return false;
      }
      </script>
  $(endif)

  <div class="login-container">
      <div class="login-header">
          <a href="#" class="login-logo">
              <span class="icon-wifi"></span> Leo <span>Konnect</span>
          </a>
          <div class="login-subtitle">WiFi Access Login</div>
      </div>

      <form name="login" action="$(link-login-only)" method="post" $(if chap-id) onsubmit="return doLogin()" $(endif)>
          <input type="hidden" name="dst" value="$(link-orig)" />
          <input type="hidden" name="popup" value="true" />
          
          $(if error)
          <div class="login-error-message show">‚ö†Ô∏è $(error)</div>
          $(endif)
          
          <div class="login-form-group">
              <label>Voucher Username</label>
              <input type="text" name="username" placeholder="Enter your username" value="$(username)" autocomplete="off" required />
          </div>
          
          <div class="login-form-group">
              <label>Voucher Password</label>
              <input type="password" name="password" placeholder="Enter your password" autocomplete="off" required />
          </div>
          
          <button type="submit" class="login-btn">Connect to WiFi</button>
          
          <div class="login-info-box">
              ‚ÑπÔ∏è Use the voucher credentials sent to your phone via SMS
          </div>
      </form>

      <div class="login-help-text">
          Don't have a voucher? <a href="#plans">Buy one below</a>
      </div>
  </div>
</section>

<section id="plans" class="plans-section container">
  <h2>Choose Your Plan</h2>
  <p class="subtext">
    Flexible, affordable plans that fit your internet needs.<br>
    No hidden fees, no contracts.
  </p>

  <div class="plans-grid" id="plansGrid">
    <!-- Plans will be loaded here dynamically -->
    <div class="loading-spinner" style="grid-column: 1/-1; text-align: center; padding: 40px;">
      <div style="font-size: 2em; color: #28a745;">‚è≥</div>
      <p style="margin-top: 10px; color: #666;">Loading plans...</p>
    </div>
  </div>
</section>

<section class="why-choose-us">
  <h2>Why Choose Leo Konnect?</h2>
  <p class="intro">We're committed to making internet access simple, affordable, and reliable for everyone in Kenya.</p>

  <div class="why-grid">
    <div class="why-card">
      <span class="icon-bolt"></span>
      <h3>Instant Activation</h3>
      <p>Get connected immediately after payment. No waiting, no setup fees.</p>
    </div>

    <div class="why-card">
      <span class="icon-wallet"></span>
      <h3>Affordable Pricing</h3>
      <p>Pay only for what you use plans start from just Ksh 10 per hour.</p>
    </div>

    <div class="why-card">
      <span class="icon-people"></span>
      <h3>Community First</h3>
      <p>Bringing reliable and affordable internet connectivity to everyone.</p>
    </div>

    <div class="why-card">
      <span class="icon-signal"></span>
      <h3>Reliable Coverage</h3>
      <p>Stay connected wherever you are with our strong and stable network.</p>
    </div>

    <div class="why-card">
      <span class="icon-support"></span>
      <h3>24/7 Support</h3>
      <p>Our customer support team is always available to help you anytime.</p>
    </div>

    <div class="why-card">
      <span class="icon-shield"></span>
      <h3>Secure Connection</h3>
      <p>Enjoy safe, encrypted, and uninterrupted internet access always.</p>
    </div>
  </div>
</section>
    
    
<footer class="site-footer">
  <div class="footer-container">
      <div class="footer-column brand"> 
          <h2 class="footer-logo">
              <span class="icon-wifi"></span> Leo <span>Konnect</span></h2>
      <p>Making internet accessible and affordable for everyone in Kenya.</p>
      <!-- <div class="social-icons">
        <a href="#"><span class="icon-facebook"></span></a>
        <a href="#"><span class="icon-twitter"></span></a>
        <a href="#"><span class="icon-instagram"></span></a>
      </div> -->
    </div>

    <div class="footer-column">
      <h3>Quick Links</h3>
      <ul>
        <li><a href="#">View Plans</a></li>
        <li><a href="#">About Us</a></li>
        <li><a href="#">Contact</a></li>
        <li><a href="#">Sign In</a></li>
      </ul>
    </div>

    <div class="footer-column">
      <h3>Support</h3>
      <ul>
        <li><a href="#">FAQ</a></li>
        <li><a href="#">Help Center</a></li>
        <li><a href="#">Terms of Service</a></li>
        <li><a href="#">Privacy Policy</a></li>
      </ul>
    </div>

    <div class="footer-column contact">
      <h3>Contact Us</h3>
      <ul>
        <li><span class="icon-map"></span> Malindi, Kenya</li>
        <li><span class="icon-phone"></span> +254 700 000 000</li>
        <li><span class="icon-email"></span> info@leokonnect.co.ke</li>
      </ul>
    </div>

  </div>

  <div class="footer-bottom">
    <p>&copy; <span id="currentYear"></span> Leo Konnect. All rights reserved.</p>
  </div>
</footer>

<!-- Purchase Modal -->
<div id="purchaseModal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    
    <div class="modal-header">
      <div class="plan-badge">Selected Plan</div>
      <h2 id="modalPlanTitle"></h2>
      <div class="plan-price" id="modalPlanPrice"></div>
      <p class="plan-description">Unlimited high-speed internet access</p>
    </div>

    <form id="payForm" class="payment-form">
      <input type="hidden" name="action" value="initiate">
      <input type="hidden" name="plan_id" id="modalPlanId">
      <input type="hidden" name="return_url" id="modalReturnUrl">
      <input type="hidden" name="ip" id="userIp">
      <input type="hidden" name="mac" id="userMac" value="">

      <div class="form-group">
        <label>
          <span class="icon-phone"></span>
          M-Pesa Phone Number
        </label>
        <input 
          type="tel" 
          name="phone" 
          required 
          placeholder="07xxxxxxxx" 
          pattern="[0-9]{10}"
          maxlength="10"
          class="phone-input"
        >
        <small>Enter your M-Pesa number to receive STK push</small>
      </div>

      <div class="payment-summary">
        <div class="summary-row">
          <span>Plan Price</span>
          <span class="amount" id="summaryPrice"></span>
        </div>
        <div class="summary-row total">
          <span>Total Amount</span>
          <span class="amount" id="summaryTotal"></span>
        </div>
      </div>

      <button type="submit" class="btn-payment">
        <span class="icon-wallet"></span>
        <span id="payButtonText">Pay via M-Pesa</span>
      </button>
    </form>

    <div id="status" class="status-message"></div>
    <div id="voucher" class="voucher-info"></div>

    <div class="purchase-footer">
      <p><span class="icon-shield"></span> Secure payment powered by M-Pesa</p>
      <p><span class="icon-support"></span> Need help? Contact support</p>
    </div>
  </div>
</div>

<script>
// MikroTik variables (will be replaced by MikroTik router)
const MIKROTIK_MAC = '$(mac)' || '';
const MIKROTIK_IP = '$(ip)' || '';
const MIKROTIK_LINK_ORIG = '$(link-orig)' || '';

// Get URL parameters
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    
    // Try to get MAC and IP from multiple sources:
    // 1. MikroTik template variables (preferred)
    // 2. URL parameters
    // 3. Empty string as fallback
    const mac = MIKROTIK_MAC !== '$(mac)' ? MIKROTIK_MAC : 
                (params.get('mac') || params.get('mac-address') || '');
    
    const ip = MIKROTIK_IP !== '$(ip)' ? MIKROTIK_IP : 
               (params.get('ip') || params.get('client-ip') || '');
    
    const returnUrl = MIKROTIK_LINK_ORIG !== '$(link-orig)' ? MIKROTIK_LINK_ORIG :
                      (params.get('return_url') || 'http://www.google.com');
    
    console.log('Captured parameters:', { mac, ip, returnUrl });
    
    return {
        from_captive: params.get('from_captive') || 0,
        return_url: returnUrl,
        mac: mac,
        ip: ip
    };
}

// Convert minutes to duration text and icon
function getDurationInfo(minutes) {
    if (minutes >= 43200) { // 30 days
        return { text: '1 month', icon: 'icon-clock' };
    } else if (minutes >= 10080) { // 7 days
        return { text: '1 week', icon: 'icon-clock' };
    } else if (minutes >= 1440) { // 1 day or more
        const days = Math.floor(minutes / 1440);
        return { text: days === 1 ? '1 day' : days + ' days', icon: 'icon-clock' };
    } else if (minutes >= 60) { // 1 hour or more
        const hours = Math.floor(minutes / 60);
        return { text: hours === 1 ? '1 hour' : hours + ' hours', icon: 'icon-clock' };
    } else {
        return { text: minutes + ' minutes', icon: 'icon-clock' };
    }
}

// Format number with commas
function formatNumber(num) {
    return Math.floor(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load plans from API
async function loadPlans() {
    const plansGrid = document.getElementById('plansGrid');
    const urlParams = getUrlParams();
    
    try {
        const response = await fetch('http://192.168.10.68/leokonnect/api/get_plans.php');
        const data = await response.json();
        
        if (data.success && data.plans.length > 0) {
            plansGrid.innerHTML = '';
            
            data.plans.forEach((plan, index) => {
                const duration = getDurationInfo(plan.duration_minutes);
                const isPopular = index === 1;
                
                const planCard = document.createElement('div');
                planCard.className = 'plan-card' + (isPopular ? ' popular' : '');
                
                planCard.innerHTML = `
                    ${isPopular ? '<div class="badge">Popular</div>' : ''}
                    
                    <div class="plan-icon">
                        <i class="${duration.icon}" style="font-size: 3em;"></i>
                    </div>
                    
                    <h3>${escapeHtml(plan.title)}</h3>
                    <p class="price">Ksh ${formatNumber(plan.price)}</p>
                    
                    <ul>
                        <li>Unlimited data for ${escapeHtml(duration.text)}</li>
                        <li>Ultra high-speed internet</li>
                        <li>Instant activation</li>
                        
                    </ul>
                    
                    <button class="btn-primary" onclick="openPurchaseModal(${plan.id}, '${escapeHtml(plan.title)}', ${plan.price})">Choose Plan</button>
                `;
                
                plansGrid.appendChild(planCard);
            });
        } else {
            plansGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">No plans available at the moment.</p>';
        }
    } catch (error) {
        console.error('Error loading plans:', error);
        plansGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #c33;">Failed to load plans. Please refresh the page.</p>';
    }
}

// Open purchase modal
function openPurchaseModal(planId, planTitle, planPrice) {
    const modal = document.getElementById('purchaseModal');
    const urlParams = getUrlParams();
    
    // Set plan details
    document.getElementById('modalPlanTitle').textContent = planTitle;
    document.getElementById('modalPlanPrice').textContent = 'Ksh ' + formatNumber(planPrice);
    document.getElementById('modalPlanId').value = planId;
    document.getElementById('summaryPrice').textContent = 'Ksh ' + formatNumber(planPrice);
    document.getElementById('summaryTotal').textContent = 'Ksh ' + formatNumber(planPrice);
    document.getElementById('payButtonText').textContent = 'Pay Ksh ' + formatNumber(planPrice) + ' via M-Pesa';
    document.getElementById('modalReturnUrl').value = urlParams.return_url;
    
    // Set MAC address from URL parameters (MikroTik provides this)
    if (urlParams.mac) {
        document.getElementById('userMac').value = urlParams.mac;
        console.log('MAC captured:', urlParams.mac);
    }
    
    // Set IP address from URL or fetch it
    if (urlParams.ip) {
        document.getElementById('userIp').value = urlParams.ip;
        console.log('IP captured:', urlParams.ip);
    } else {
        fetch('https://api.ipify.org?format=json')
            .then(res => res.json())
            .then(data => document.getElementById('userIp').value = data.ip)
            .catch(() => document.getElementById('userIp').value = '');
    }
    
    // Reset form and messages
    document.getElementById('payForm').reset();
    document.getElementById('status').className = 'status-message';
    document.getElementById('status').innerHTML = '';
    document.getElementById('voucher').className = 'voucher-info';
    document.getElementById('voucher').innerHTML = '';
    
    // Show modal
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// Close modal
function closePurchaseModal() {
    const modal = document.getElementById('purchaseModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Modal event listeners
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('purchaseModal');
    const closeBtn = document.querySelector('.modal-close');
    
    // Close button
    closeBtn.onclick = closePurchaseModal;
    
    // Click outside modal
    window.onclick = function(event) {
        if (event.target == modal) {
            closePurchaseModal();
        }
    };
    
    // Payment form submission
    const payForm = document.getElementById('payForm');
    const statusDiv = document.getElementById('status');
    const voucherDiv = document.getElementById('voucher');
    const urlParams = getUrlParams();
    const fromCaptive = urlParams.from_captive == 1;

    payForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        statusDiv.className = "status-message loading";
        statusDiv.innerHTML = '<div class="spinner"></div> <span>Initiating payment...</span>';
        voucherDiv.innerHTML = "";

        try {
            const formData = new FormData(payForm);
            const res = await fetch('http://192.168.10.68/leokonnect/api/payments.php', { method: 'POST', body: formData });
            const data = await res.json();

            // Check for errors
            if (data.error) {
                statusDiv.className = "status-message error";
                statusDiv.innerHTML = `<span class="icon-shield"></span> <strong>Error:</strong> ${data.error}`;
                return;
            }

            if (!data || !data.payment_id) {
                statusDiv.className = "status-message error";
                statusDiv.innerHTML = '<span class="icon-shield"></span> Could not start payment. Please try again.';
                return;
            }

            const paymentId = data.payment_id;
            const returnUrl = formData.get('return_url');

            // Check if using SmartPay (STK push) or mock
            if (data.gateway === 'SmartPay') {
                statusDiv.className = "status-message info";
                statusDiv.innerHTML = '<div class="spinner"></div> <span><strong>STK push sent!</strong><br>Please check your phone and enter your M-Pesa PIN</span>';
                
                // Poll for payment confirmation
                const poll = setInterval(async () => {
                    const checkRes = await fetch(`http://192.168.10.68/leokonnect/api/check_payment.php?payment_id=${paymentId}`);
                    const checkData = await checkRes.json();

                    if (checkData.status === 'success') {
                        clearInterval(poll);
                        statusDiv.className = "status-message success";
                        statusDiv.innerHTML = '<span class="icon-rocket"></span> <strong>Payment Successful!</strong>';
                        
                        voucherDiv.className = "voucher-info show";
                        voucherDiv.innerHTML = `
                            <div class="voucher-card">
                                <h3><span class="icon-lock"></span> Your WiFi Credentials</h3>
                                <div class="credential-row">
                                    <span class="label">Username:</span>
                                    <span class="value">${checkData.username}</span>
                                </div>
                                <div class="credential-row">
                                    <span class="label">Password:</span>
                                    <span class="value">${checkData.password}</span>
                                </div>
                                <div class="credential-row">
                                    <span class="label">Valid Until:</span>
                                    <span class="value">${checkData.expires}</span>
                                </div>
                                <p class="voucher-note">
                                    <span class="icon-support"></span> 
                                    Use these credentials to login to the WiFi network
                                </p>
                            </div>
                        `;
                        
                        // If coming from captive portal, redirect after 5 seconds
                        if (fromCaptive) {
                            setTimeout(() => {
                                window.location.href = returnUrl || 'http://www.google.com';
                            }, 5000);
                        }
                    } else if (checkData.status === 'failed') {
                        clearInterval(poll);
                        statusDiv.className = "status-message error";
                        statusDiv.innerHTML = '<span class="icon-shield"></span> <strong>Payment failed.</strong> Please try again.';
                    } else {
                        statusDiv.className = "status-message info";
                        statusDiv.innerHTML = '<div class="spinner"></div> <span>Waiting for payment confirmation...<br><small>Please enter your M-Pesa PIN on your phone</small></span>';
                    }
                }, 3000);

                // Stop polling after 2 minutes
                setTimeout(() => {
                    clearInterval(poll);
                    if (!voucherDiv.innerHTML) {
                        statusDiv.className = "status-message warning";
                        statusDiv.innerHTML = '<span class="icon-clock"></span> <strong>Payment timeout.</strong> Please check your M-Pesa messages or try again.';
                    }
                }, 120000);

            } else if (data.gateway === 'MOCK') {
                // Mock payment - instant success
                const autoAuth = data.auto_authenticated || false;
                const successMsg = autoAuth 
                    ? '<span class="icon-rocket"></span> <strong>Payment Successful!</strong><br><small>You are now connected to WiFi automatically!</small>'
                    : '<span class="icon-rocket"></span> <strong>Payment Successful!</strong> <small>(Test Mode)</small>';
                
                statusDiv.className = "status-message success";
                statusDiv.innerHTML = successMsg;
                
                if (data.voucher) {
                    // Extract voucher details from nested response
                    const voucherData = data.voucher.voucher || data.voucher;
                    const sessionData = data.voucher.session || {};
                    
                    const username = sessionData.hotspot_username || voucherData.username;
                    const password = sessionData.hotspot_password || voucherData.password;
                    const expiry = sessionData.expires_at || voucherData.expiry || data.voucher.new_expiry;
                    
                    const authNote = autoAuth
                        ? '<p class="voucher-note success-note"><span class="icon-rocket"></span> You are automatically connected! No manual login needed.<br>Use these credentials as backup if you get disconnected.</p>'
                        : '<p class="voucher-note"><span class="icon-support"></span> Use these credentials to login to the WiFi network</p>';
                    
                    voucherDiv.className = "voucher-info show";
                    voucherDiv.innerHTML = `
                        <div class="voucher-card">
                            <h3><span class="icon-lock"></span> Your WiFi Credentials</h3>
                            ${authNote}
                            <div class="credential-row">
                                <span class="label">Username:</span>
                                <span class="value">${username}</span>
                            </div>
                            <div class="credential-row">
                                <span class="label">Password:</span>
                                <span class="value">${password}</span>
                            </div>
                            <div class="credential-row">
                                <span class="label">Valid Until:</span>
                                <span class="value">${expiry}</span>
                            </div>
                        </div>
                    `;
                    
                    // Auto-submit login form if auto-authentication is enabled
                    if (autoAuth && fromCaptive && username && password) {
                        statusDiv.className = "status-message success";
                        statusDiv.innerHTML = '<div class="spinner"></div> <span><strong>Payment Successful!</strong><br>Connecting you to WiFi automatically...</span>';
                        
                        // Submit login form to MikroTik
                        setTimeout(() => {
                            const loginForm = document.createElement('form');
                            loginForm.method = 'POST';
                            loginForm.action = 'http://192.168.10.67/login';
                            
                            const usernameInput = document.createElement('input');
                            usernameInput.type = 'hidden';
                            usernameInput.name = 'username';
                            usernameInput.value = username;
                            
                            const passwordInput = document.createElement('input');
                            passwordInput.type = 'hidden';
                            passwordInput.name = 'password';
                            passwordInput.value = password;
                            
                            const dstInput = document.createElement('input');
                            dstInput.type = 'hidden';
                            dstInput.name = 'dst';
                            dstInput.value = returnUrl || 'http://www.google.com';
                            
                            loginForm.appendChild(usernameInput);
                            loginForm.appendChild(passwordInput);
                            loginForm.appendChild(dstInput);
                            
                            document.body.appendChild(loginForm);
                            loginForm.submit();
                        }, 1500);
                    } else if (fromCaptive) {
                        setTimeout(() => {
                            window.location.href = returnUrl || 'http://www.google.com';
                        }, 3000);
                    }
                }
            }

        } catch (err) {
            statusDiv.className = "status-message error";
            statusDiv.innerHTML = `<span class="icon-shield"></span> <strong>Payment error:</strong> ${err.message}`;
        }
    });
});

// Set current year
document.getElementById('currentYear').textContent = new Date().getFullYear();

// Remove hash from URL on page load to prevent auto-scroll
if (window.location.hash) {
    history.replaceState(null, null, ' ');
}

// Load plans when page loads
document.addEventListener('DOMContentLoaded', loadPlans);
</script>

</body>
</html>
